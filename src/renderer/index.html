<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Electron</title>
    <script src="/libs/live2dcubismcore.min.js"></script>
    <script src="/libs/live2d.min.js"></script>
  </head>

  <body>
    <div id="root"></div>
    <audio id="player" controls autoplay style="display:none;"></audio>

    <script type="module" src="/src/main.tsx"></script>
    <script>
      // const mockData = {
      //   play_url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
      //   play_background_url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"
      // };

      // const player = document.getElementById("player");

      // const base64Promise = fetchMp3AsBase64(mockData.play_url);
      // const bgAudioPromise = new Promise(resolve => {
      //     player.src = mockData.play_background_url;
      //     player.oncanplaythrough = () => resolve();
      // });

      // Promise.all([base64Promise, bgAudioPromise]).then(([base64]) => {
      //     if (base64) {
      //         console.log('Base64:', base64.slice(0, 100) + "..."); // å°å‰100å­—ç¯€é è¦½
      //         player.play();
      //         window.live2dModel?.speak?.(`data:audio/wav;base64,${base64}`); // è‹¥ç„¡ live2dModel ä¹Ÿä¸å ±éŒ¯
      //     }
      // });
      const ws = new WebSocket("wss://8a7d-219-70-65-54.ngrok-free.app/ws_music");
      ws.onopen = () => console.log("âœ… WebSocket å·²é€£ç·š");
      ws.onmessage = function(event) {
          const data = JSON.parse(event.data);
          if (data.play_url) {
              console.log("ğŸ”” æ”¶åˆ°æ’­æ”¾é€šçŸ¥ï¼š", data.play_url);
              const player = document.getElementById("player");

              // å–å¾— base64 èˆ‡ background audio çš„ Promise
              const base64Promise = fetchMp3AsBase64(data.play_url);
              const bgAudioPromise = new Promise(resolve => {
                  player.src = data.play_background_url;
                  player.oncanplaythrough = () => resolve(); // ç¢ºä¿å¯ä»¥æ’­æ”¾
              });

              // åŒæ­¥ç­‰å¾…å…©å€‹éƒ½ ready
              Promise.all([base64Promise, bgAudioPromise]).then(([base64]) => {
                  if (base64) {
                      console.log('Base64:', base64);
                      // é–‹å§‹æ’­æ”¾å…©è€…
                      player.play();
                      window.live2dModel.speak(`data:audio/wav;base64,${base64}`);
                  }
              });
          }
      };
      
      ws.onopen = () => console.log("âœ… WebSocket å·²é€£ç·š");
      ws.onclose = () => console.log("âŒ WebSocket é—œé–‰");

      async function fetchMp3AsBase64(mp3Url) {
          try {
            const response = await fetch(mp3Url);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const blob = await response.blob();

            return await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => {
                const base64data = reader.result.split(',')[1]; // å»æ‰ data:audio/mp3;base64, å‰ç¶´
                resolve(base64data);
              };
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            });
          } catch (error) {
            console.error('Error fetching or converting MP3:', error);
            return null;
          }
        }


    </script>
  </body>
</html>
